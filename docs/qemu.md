# Qemu Installation and Usage

This tutorial provides comprehensive instructions for setting up an embedded OS on QEMU, using Ubuntu as the host operating system.

## Installation

The following packages have to be installed on the system:

- QEMU
- ARM GCC toolchain

QEMU can be installed on Ubuntu using the following commands:

```bash
sudo apt update && sudo apt upgrade
sudo apt install qemu-system
```

The Cross Compiler can be installed in the following way

Download the binaries from the following [Website](https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads)

For Ubuntu download the file ending in .tar.xz in the _AArch32 bare-metal target (arm-none-eabi)_ section

Extract the files into a chosen directory, for instance /usr/share/:

```bash
sudo tar -xvf arm-gnu-toolchain-<VERSION>-x86_64-arm-none-eabi.tar.xz -C /usr/share/
```

Set up symbolic link to point to the extracted version of the compiler tools:

```bash
sudo ln -s /usr/share/garm-gnu-toolchain-<VERSION>-x86_64-arm-none-eabi/bin/arm-* /usr/bin/
```

Check if the installation was successful by inspecting the versions:

```bash
arm-none-eabi-gcc --version
```

## Usage

In this section a guide on how to use QEMU to emulate an embedded system is provided.

QEMU offers several packages for each system to emulate `qemu-system-<target_arch>` In our case the target architecture is 32-bit arm thus the command to be used is `qemu-system-arm`

Standard options to be provided are:

- **-machine name**: this specify the machine to be emulated. To get a list of all available machine run `qemu-system-arm -machine help`

- **-cpu cpu**: specify the cpu to be used. To get a list of all cpus available run `qemu-system-arm -cpu help`

- **-kernel bzImage**: provide the executable to be run as kernel image

Other options useful for debugging are:

- **-serial dev**: redirect the serial port to the device 'dev'

- **-monitor dev**: redirect the monitor to char device 'dev'

- **-S**: freeze CPU at startup

- **-gdb dev**: accept gdb connection on 'dev'

- **-s**: short end for `-gdb tcp::1234`

- **-semihosting**: semihosting mode

- **-semihosting-config [enable=on|off][,target=native|gdb|auto][,chardev=id][,userspace=on|off][,arg=str[,...]]**: semihosting configuration

### FreeRTOS

The embedded OS of choice for this project is **FreeRTOS**. It can be downloaded both from the official [website](https://www.freertos.org/a00104.html) or it can be cloned from github.

```bash
git clone https://github.com/FreeRTOS/FreeRTOS.git
```

if you cloned the repo of this project, FreeRTOS is available as a submodule so you do not need to clone it again.

### QEMU Demo

To better understand how to emulate FreeRTOS on QEMU, a Demo Project is provided from FreeRTOS.

The demo can be found in the folder `FreeRTOS/FreeRTOS/Demo/CORTEX_MPS2_QEMU_IAR_GCC`.

#### Building the Demo

To build the demo run the following command in the `build/gcc` directory.

```bash
make
```

A successful build creates the elf file `output/RTOSDemo.out`.

#### Running the FreeRTOS Demo on QEMU

Start QEMU with the following command, replacing `[path-to]` with the correct path to the `RTOSDemo.out` file generated by the GCC build.

```bash
qemu-system-arm -machine mps2-an385 -cpu cortex-m3 -kernel [path-to]/RTOSDemo.out -monitor none -nographic -serial stdio -s -S
```

Omit `-s -S` if the user just wants to run the FreeRTOS application in QEMU without attaching the debugger.

#### Debugging with GDB

The user can now use `arm-none-eabi-gdb` to start a command line debug session following the steps below:

Navigate to the path to `RTOSDemo.out`, and start `arm-none-eabi-gdb`.

```bash
arm-none-eabi-gdb RTOSDemo.out -ex "target remote localhost:1234"
```

## xPack QEMU

Installing QEMU from xPack will give access to the `qemu-system-gnuarmeclipse` package. This is a fork of `qemu-system-arm` which includes a varaiety of boards, and for some of them provide a nice view of the board during the simulation.

We will use this package to emulate the **NUCLEO-F103RB** board.

### Installation

#### Prerequisite

- npm
- xpm

We will not go into detail on how to install npm, several guides are available online.

To install `xpm` it is enough to run

```bash
npm i --global xpm
```

#### Install xPack QEMU

To globally install xPack QEMU run the following commands

```bash
xpm install --global @xpack-dev-tools/qemu-arm
```

The packages will be installed at the path `~/.local/xPack/@xpack-dev-tools/qemu-arm/<VERSION>/.content/bin/`.

Create a link to be able to call the package from command line directly

```bash
sudo ln -s ~/.local/xPack/@xpack-dev-tools/qemu-arm/<VERSION>/.content/bin/qemu-system-gnuarmeclipse /usr/bin/qemu-system-gnuarmeclipse
```
