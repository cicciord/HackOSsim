# Qemu Installation and Usage

This tutorial provides comprehensive instructions for setting up FreeRTOS on QEMU, using Ubuntu as the host operating system.

## Prerequisites and QEMU Installation

Before beginning the setup process, one must ensure that the following dependencies are installed on their system:

- QEMU
- Git
- ARM GCC toolchain

### Installing Dependencies

These dependencies can be installed on Ubuntu using the following commands:

```bash
sudo apt-get update
sudo apt-get install qemu git 
```

### Installing Cross-Compiler

Remove existing arm-none installation (if any):

```bash
sudo apt remove arm-none-eabi-gcc
```

Download the binaries from the following [Website](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads)
Extract the files into a chosen directory; for instance, /usr/share/:

```bash
sudo tar xjf gcc-arm-none-eabi-YOUR-VERSION.bz2 -C /usr/share/
```

Set up symbolic link to point to the extracted version of the compiler tools:

```bash
sudo ln -s /usr/share/gcc-arm-none-eabi-YOUR-VERSION/bin/arm-none-eabi-gcc /usr/bin/arm-none-eabi-gcc
sudo ln -s /usr/share/gcc-arm-none-eabi-YOUR-VERSION/bin/arm-none-eabi-g++ /usr/bin/arm-none-eabi-g++
sudo ln -s /usr/share/gcc-arm-none-eabi-YOUR-VERSION/bin/arm-none-eabi-gdb /usr/bin/arm-none-eabi-gdb
sudo ln -s /usr/share/gcc-arm-none-eabi-YOUR-VERSION/bin/arm-none-eabi-size /usr/bin/arm-none-eabi-size
sudo ln -s /usr/share/gcc-arm-none-eabi-YOUR-VERSION/bin/arm-none-eabi-ob /usr/bin/arm-none-eabi-ob
```

Check if the installation was successful by inspecting the versions:

```bash
arm-none-eabi-gcc --version
arm-none-eabi-g++ --version
arm-none-eabi-gdb --version
arm-none-eabi-size --version
```

### Cloning the Official FreeRTOS Repository from GitHub

```bash
git clone https://github.com/FreeRTOS/FreeRTOS.git
cd FreeRTOS 
```

### Navigating to the QEMU Demo Directory

```bash
cd Demo/CORTEX_MPS2_QEMU_IAR_GCC
```

## Building and Executing the Demo Application

Within the `main.c` file, there is a configuration flag named `mainCREATE_SIMPLE_BLINKY_DEMO_ONLY`. This flag allows the user to select the type of demo application to be generated. There are two types of demo applications:

- **Simple Blinky Demo**: If `mainCREATE_SIMPLE_BLINKY_DEMO_ONLY` is set to 1, a simple blinky demo is generated. This demo is basic and typically involves tasks that blink LEDs at different frequencies.
- **Comprehensive Test and Demo Application**: If `mainCREATE_SIMPLE_BLINKY_DEMO_ONLY` is set to 0, a comprehensive test and demo application is generated. This demo is more complex and includes a variety of tasks that test the FreeRTOS API and port.

By adjusting the value of `mainCREATE_SIMPLE_BLINKY_DEMO_ONLY`, it's possible to control the complexity of the demo application that is built and run on the system. This flexibility allows the user to start with a simple application and gradually move to more complex applications as they become more familiar with FreeRTOS.

### Building the FreeRTOS Demo for QEMU

```bash
cd build/gcc
make
```

A successful build creates the elf file `RTOSDemo.out`.

### Running the FreeRTOS Demo on QEMU

Start QEMU with the following command line, replacing `[path-to]` with the correct path to the `RTOSDemo.out` file generated by the GCC build.

```bash
qemu-system-arm -machine mps2-an385 -cpu cortex-m3 -kernel [path-to]/RTOSDemo.out -monitor none -nographic -serial stdio -s -S
```

Omit `-s -S` if the user just wants to run the FreeRTOS application in QEMU without attaching the debugger.

## Debugging with GDB

The user can now use `arm-none-eabi-gdb` to start a command line debug session following the steps below:

### Starting GDB

Navigate to the path to `RTOSDemo.out`, and start `arm-none-eabi-gdb`.

```bash
arm-none-eabi-gdb RTOSDemo.out
```

### Using GDB

The following bash commands can be used to start a command line debug session:

```bash
# Connect GDB to QEMU (default port for QEMU is 1234)
(gdb) target remote localhost:1234

# Set breakpoints
(gdb) break main

# Start debugging
(gdb) continue

# Quit GDB
(gdb) quit